<!-- Chat Modal -->
<div class="chat__modal" id="chatModal">
  <div class="chat__modal-content">
      <div class="chat__modal-header" onclick="toggleChatModal()">
              <img src="{{ user.profile.image.url }}" alt="Profile Picture" class="profile-pic me-2"  style="width: 40px; border-radius: 50%;">
              <p style="margin: 0;">{{ user_data.user.first_name }}</p>
          <button class="close-button" onclick="closeChatModal()">&times;</button>
      </div>
      <hr style="margin: 0;">
      <div class="chat__modal-body" id="chatModalBody" style="display: none;">
          <div class="chat__item__container" id="id_chat_item_container">
              <!-- Display previous chat messages -->
              {% for message in chat_messages %}
                  <div>{{ message.sender.username }} {% if message.receiver %} to {{ message.receiver.username }} {% endif %}: {{ message.message }}</div>
              {% endfor %}
          </div>
          <div class="chat__input-container">
              <form id="chatForm" method="post">
                  {% csrf_token %}
                  <input type="text" name="message" id="id_message_send_input" />
                  <button type="submit" id="id_message_send_button"><i class="far fa-paper-plane"></i></button>
              </form>
          </div>
          {% if can_clear_chat %}
          <div class="chat__clear-container">
              <a href="?clear_chat=true">Clear Chat</a>
          </div>
          {% endif %}
      </div>
  </div>
  <input type="hidden" id="receiverUserPk" name="receiverUserPk" />
  <input type="hidden" id="roomId" name="roomId" value="{{ chat_room_id }}" />
</div>

<!-- Chat List (assuming it's at the bottom right corner) -->
<div class="chat__list" id="chatList">
  <!-- Display latest chat rooms -->
  {% for room in user_chat_rooms %}
      <div class="chat__room">
          <a href="{% url 'chat_page' username=room.other_user.username %}" class="openChatModal">
              <div class="chat__room-title">{{ room.other_user.username }}</div>
              <!-- Add more details as needed -->
          </a>
      </div>
  {% endfor %}
</div>
  
<script>
// WebSocket initialization and event handling
const chatSocket = new WebSocket("ws://" + window.location.host + "/");
const userPk = "{{ request.user.pk }}";

chatSocket.onopen = function (e) {
    console.log("WebSocket connection opened successfully!");
};

chatSocket.onclose = function (e) {
    console.log("WebSocket connection closed unexpectedly!");
};

// Focus on the message input field when page loads
document.querySelector("#id_message_send_input").focus();

// Automatically send message on Enter key press
document.querySelector("#id_message_send_input").onkeyup = function (e) {
    if (e.keyCode == 13) {
        document.querySelector("#id_message_send_button").click();
    }
};

// Toggle chat modal body height
const chatModal = document.getElementById("chatModal");
const chatModalBody = document.getElementById("chatModalBody");
let expanded = false;

function toggleChatModal() {
    expanded = !expanded;
    if (expanded) {
        chatModalBody.style.height = "50vh"; // Expand the modal body
        chatModal.style.display = "block";
        chatModalBody.style.display = "block";
        chatModal.style.right= `350px`;
    } else {
        chatModalBody.style.height = "0"; // Collapse the modal body
        chatModalBody.style.display = "none";
    }
}

// Open chat modal function with user data
function openChatModal(userPk) {
    // Fetch user details
    fetch(`/api/user/${userPk}/`)
        .then(response => response.json())
        .then(data => {
            console.log('user data', data);  // Debugging: log retrieved user data

            // Update modal with user data
            const profilePic = document.querySelector(".profile-pic");
            const usernameElement = document.querySelector(".chat__modal-header p");

            if (data.image_url) {
                profilePic.src = data.image_url;  // Update profile picture if available
                profilePic.style.display = "block";
            } else {
                profilePic.style.display = "none";  // Hide profile picture if not available
            }

            usernameElement.textContent = data.username;  // Update username

            // Display chat modal
            toggleChatModal();
        })
        .catch(error => {
            console.error('Error fetching user details:', error);
            // Handle errors, e.g., show an error message in the modal
        });

    // Fetch messages (if needed)
    // This part can be updated similarly to fetch and display messages
}


// Function to close chat modal
function closeChatModal() {
    chatModal.style.display = "none";
}

// Event listener for close button
document.querySelector(".close-button").addEventListener('click', closeChatModal);

// Form submission for sending messages
document.querySelector("#chatForm").onsubmit = function (e) {
    e.preventDefault(); // Prevent form submission

    var messageInput = document.querySelector("#id_message_send_input").value;
    var receiverUserPk = document.querySelector("#receiverUserPk").value; // Get the receiver userPk
    var room_id = document.querySelector("#roomId").value; // Get the room ID

    console.log("Sending message:", messageInput, " to user:", receiverUserPk, " in room:", room_id);

    // Send message via WebSocket
    chatSocket.send(JSON.stringify({
        message: messageInput,
        username: "{{ request.user.username }}",
        receiver_id: receiverUserPk,
        room_id: room_id
    }));

    document.querySelector("#id_message_send_input").value = ""; // Clear input after sending
};

// Event listener for opening chat modal from chat list
document.addEventListener('DOMContentLoaded', function() {
    const chatIcons = document.querySelectorAll('.openChatModal');

    chatIcons.forEach(chatIcon => {
        chatIcon.addEventListener('click', (event) => {
            const clickedUserPk = event.currentTarget.dataset.userPk;
            openChatModal(clickedUserPk);
        });
    });
});

// WebSocket message reception
chatSocket.onmessage = function (e) {
    console.log("Received message through WebSocket!");
    const data = JSON.parse(e.data);
    console.log("Message data:", data);
    
    // Create a new chat message element
    var messageElement = document.createElement("div");
    messageElement.textContent = `${data.username}: ${data.message}`;
    
    // Append the message element to the chat body container
    var chatBodyContainer = document.querySelector("#id_chat_item_container");
    chatBodyContainer.appendChild(messageElement);
};

  </script>
  
  