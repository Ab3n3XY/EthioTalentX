<!-- Chat Modal -->
<div class="chat__modal" id="chatModal">
    <div class="chat__modal-content">
        <div class="chat__modal-header" onclick="toggleChatModal()">
            <img src="" alt="Profile Picture" id="chatProfilePic" class="profile-pic me-2" style="width: 40px; border-radius: 50%;">
            <p id="chatUserName" style="margin: 0;"></p>
            <button type="button" class="close-button" onclick="closeChatModal()">&times;</button>
        </div>
        <hr style="margin: 0;">
        <div class="chat__modal-body" id="chatModalBody">
            <div class="chat__item__container" id="id_chat_item_container">
                {% for message in chat_messages %}
                    <div>{{ message.sender.username }}{% if message.receiver %} to {{ message.receiver.username }}{% endif %}: {{ message.message }}</div>
                {% endfor %}
            </div>
            <div class="chat__input-container">
              <form id="chatForm">
                <input type="text" id="id_message_send_input" name="message" placeholder="Type your message..." />
                <input type="hidden" id="receiverUserPk" value=""/>
                <input type="hidden" id="chat_room_pk" value=""/>
                <button type="submit" id="id_message_send_button"><i class="far fa-paper-plane"></i></button>
            </form>
            </div>
            {% if can_clear_chat %}
            <div class="chat__clear-container">
                <a href="?clear_chat=true">Clear Chat</a>
            </div>
            {% endif %}
        </div>
    </div>
  </div>

<script>
// Initialize WebSocket
const chatSocket = new WebSocket("ws://" + window.location.host + "/");

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.openChatModal').forEach(chatIcon => {
        chatIcon.addEventListener('click', (event) => {
            const clickedUserPk = event.currentTarget.dataset.userPk;
            const currentUserId = event.currentTarget.dataset.userId;
            console.log("Chat icon clicked");
            console.log("Clicked user PK:", clickedUserPk);
            console.log("Current user ID:", currentUserId);
            openChatModal(clickedUserPk, currentUserId);
        });
    });

    document.querySelector("#chatForm").addEventListener('submit', (e) => {
        e.preventDefault();
        const messageInput = document.querySelector("#id_message_send_input").value.trim();
        const receiverUserPk = document.querySelector("#receiverUserPk").value;
        const roomId = document.querySelector("#chat_room_pk").value;
        console.log("Form submitted");
        console.log("Message input:", messageInput);
        console.log("Receiver user PK:", receiverUserPk);
        console.log("Chat room ID:", roomId);
        if (messageInput && receiverUserPk && roomId) {
            sendMessage(messageInput, receiverUserPk, roomId);
        } else {
            console.error("Missing message input, receiver user PK, or chat room ID");
        }
    });
});

// Function to send message via WebSocket
function sendMessage(message, receiverPk, roomId) {
    console.log("Preparing to send message");
    console.log("Message:", message);
    console.log("Receiver PK:", receiverPk);
    console.log("Room ID:", roomId);
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            message: message,
            receiver_id: receiverPk,
            roomId: roomId
        }));
        document.querySelector("#id_message_send_input").value = "";
    } else {
        console.error("WebSocket is not open");
    }
}


// Toggle chat modal body height
const chatModal = document.getElementById("chatModal");
const chatModalBody = document.getElementById("chatModalBody");
let expanded = false;

function toggleChatModal() {
    expanded = !expanded;
    if (expanded) {
        chatModalBody.style.height = "50vh"; // Expand the modal body
        chatModal.style.display = "block";
        chatModalBody.style.display = "block";
        chatModal.style.right= `350px`;
    } else {
        chatModalBody.style.height = "0"; // Collapse the modal body
        chatModalBody.style.display = "none";
    }
}

// Function to close chat modal
function closeChatModal(event) {
        chatModal.style.display = "none";
}


function openChatModal(userPk, userId) {
    console.log("Opening chat modal with User PK:", userPk, "User ID:", userId);
    document.querySelector("#receiverUserPk").value = userPk;
    document.querySelector("#chat_room_pk").value = ""; // Reset chat room ID
    
    Promise.all([
        fetch(`/api/user/${userPk}/`).then(response => response.json()),
        fetch(`/api/check-chat-room/${userPk}/`).then(response => response.json())
    ])
    .then(([userData, chatRoomData]) => {
        console.log("Fetched user data:", userData);  // Debug statement
        console.log("Fetched chat room data:", chatRoomData);  // Debug statement
        
        // Ensure room_id is correctly extracted from chatRoomData
        const roomId = chatRoomData.room_id;
        console.log("Room ID:", roomId);

        // Update modal header with user data
        document.querySelector("#chat_room_pk").value = roomId;
        document.querySelector("#chatProfilePic").src = userData.image;
        document.querySelector("#chatUserName").textContent = userData.first_name;

        if (chatRoomData.exists) {
            loadChatRoomMessages(userId, roomId);
        } else {
            createChatRoom(userPk, userId);
        }
        toggleChatModal();
    })
    .catch(error => console.error('Error fetching user details or chat room data:', error));
}

function createChatRoom(userPk, userId) {
    console.log("Creating new chat room with user IDs:", userPk, userId);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/api/create-chat-room/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            user_id_1: userId, // Correcting the parameter usage
            user_id_2: userPk
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        document.querySelector("#chat_room_pk").value = data.room_id;
        console.log("New chat room created:", data.room_id);
        loadChatRoomMessages(data.room_id);
    })
    .catch(error => console.error('Error creating chat room:', error));
}

// Function to load messages for a specific chat room (using user_pk and room_id)
function loadChatRoomMessages(userId, roomId) {
    console.log("Loading messages for user:", userId, "and room:", roomId);
    fetch(`/api/messages/${userId}/${roomId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(messages => {
            console.log("Fetched messages:", messages);  // Debug statement
            displayMessages(messages,userId);
        })
        .catch(error => console.error('Error fetching messages:', error));
}

// Function to display messages received from the backend
function displayMessages(messages,userId) {
    const chatMessagesContainer = document.querySelector("#id_chat_item_container");
    chatMessagesContainer.innerHTML = '';  // Clear existing messages

    messages.forEach(message => {
        const messageElement = document.createElement("div");
        messageElement.classList.add("chat-message");

        // Determine message sender
        const isMyMessage = message.sender_id === userId;  // Assuming UserId is defined somewhere

        // Construct message HTML
        messageElement.innerHTML = `
            <div>${message.sender_username}: ${message.message}</div>
        `;
        
        // Append message element to container
        chatMessagesContainer.appendChild(messageElement);
    });
}



// WebSocket event listeners
chatSocket.onopen = () => console.log("WebSocket connection opened!");
chatSocket.onclose = () => console.log("WebSocket connection closed!");
chatSocket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const messageElement = document.createElement("div");
    messageElement.textContent = `${data.username}: ${data.message}`;
    const chatBodyContainer = document.querySelector("#id_chat_item_container");
    chatBodyContainer.appendChild(messageElement);
    chatBodyContainer.scrollTop = chatBodyContainer.scrollHeight;
};

</script>
