<!-- Chat Modal -->
<div class="chat__modal" id="chatModal">
    <div class="chat__modal-content" id="chatModalContent">
      <div class="chat__modal-header" onclick="toggleChatModal()">
        <img src="" alt="Profile Picture" id="chatProfilePic" class="profile-pic me-2" style="width: 50px; border-radius: 50%;">
        <p id="chatUserName" style="margin: 0; font-weight: bolder;"></p>
        <button type="button" class="close-button" onclick="closeChatModal()">&times;</button>
      </div>
      <hr style="margin: 0;">
      <div class="chat__modal-body" id="chatModalBody">
        <div class="chat__item__container" id="id_chat_item_container">
          {% for message in chat_messages %}
          <div class="chat-message">
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="chat__input-container" id="chat__input-container">
        <form id="chatForm">
          <input type="text" id="id_message_send_input" name="message" placeholder="Type your message..." />
          <input type="hidden" id="receiverUserPk" value=""/>
          <input type="hidden" id="chat_room_pk" value=""/>
          <button type="submit" id="id_message_send_button"><i class="far fa-paper-plane" style="background-color: transparent; border: none;"></i></button>
        </form>
      </div>
      <div class="chat__clear-container" id="chat__clear-container" >
        <a href="?clear_chat=true" id="clearChatLink">Clear Chat</a>
      </div>
    </div>
  </div>
  

<script>
let chatSocket;

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.openChatModal').forEach(chatIcon => {
        chatIcon.addEventListener('click', (event) => {
            const clickedUserPk = event.currentTarget.dataset.userPk;
            const currentUserId = event.currentTarget.dataset.userId;
            openChatModal(clickedUserPk, currentUserId);
        });
    });

    document.querySelector("#chatForm").addEventListener('submit', (e) => {
        e.preventDefault();
        const messageInput = document.querySelector("#id_message_send_input").value.trim();
        const receiverUserPk = document.querySelector("#receiverUserPk").value;
        const roomId = document.querySelector("#chat_room_pk").value;
        if (messageInput && receiverUserPk && roomId) {
            sendMessage(messageInput, receiverUserPk, roomId);
        } else {
            console.error("Missing message input, receiver user PK, or chat room ID");
        }
    });
});

function openChatModal(userPk, userId) {
    document.querySelector("#receiverUserPk").value = userPk;
    document.querySelector("#chat_room_pk").value = ""; // Reset chat room ID
    
    Promise.all([
        fetch(`/api/user/${userPk}/`).then(response => response.json()),
        fetch(`/api/check-chat-room/${userPk}/`).then(response => response.json())
    ])
    .then(([userData, chatRoomData]) => {
        const roomId = chatRoomData.room_id;


        document.querySelector("#chat_room_pk").value = roomId;
        document.querySelector("#chatProfilePic").src = userData.image;
        document.querySelector("#chatUserName").textContent = userData.first_name;

        if (chatRoomData.exists) {
            loadChatRoomMessages(userId, roomId);
        } else {
            createChatRoom(userPk, userId);
        }

        if (chatSocket) {
            chatSocket.close(); // Close any existing connection
        }
        chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/?room=${roomId}`);

        chatSocket.onopen = () => console.log("WebSocket connection opened!");
        chatSocket.onclose = () => console.log("WebSocket connection closed!");
        chatSocket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const messageElement = document.createElement("div");
            messageElement.classList.add("chat-message");

            messageElement.innerHTML = `
            <img src="${data.sender_proile_picture}" alt="Profile Picture" class="profile-pic" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
            <strong><span>${data.sender_first_name}</span> <span>${data.sender_last_name}</span> .</strong>
             <span class="timestamp" style="font-size: 0.8em; color: gray;">
                ${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
            </span>
            <div style="margin-left: 60px; margin-top: 5px; font-weight: none;"><span >${data.message}</span></div>
            
            `;

            const chatBodyContainer = document.querySelector("#chatModalBody");
            chatBodyContainer.appendChild(messageElement);
            chatBodyContainer.scrollTop = chatBodyContainer.scrollHeight;
        };

        toggleChatModal();
    })
    .catch(error => console.error('Error fetching user details or chat room data:', error));
}

function sendMessage(message, receiverPk, roomId) {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            message: message,
            receiver_id: receiverPk,
            roomId: roomId
        }));
        document.querySelector("#id_message_send_input").value = "";
    } else {
        console.error("WebSocket is not open");
    }
}

// Toggle chat modal body height
const chatModal = document.getElementById("chatModal");

let expanded = false;

function toggleChatModal() {
    expanded = !expanded;
    if (expanded) {
        chatModal.style.height = "70vh";
        chatModal.style.display = "block";
    } else {
        chatModal.style.height = "60px";
    }
}

function closeChatModal(event) {
    chatModal.style.display = "none";
}

function createChatRoom(userPk, userId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/api/create-chat-room/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            user_id_1: userId,
            user_id_2: userPk
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        document.querySelector("#chat_room_pk").value = data.room_id;
        console.log("New chat room created:", data.room_id);
        loadChatRoomMessages(userId, data.room_id);
    })
    .catch(error => console.error('Error creating chat room:', error));
}

function loadChatRoomMessages(userId, roomId) {
    fetch(`/api/messages/${userId}/${roomId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(messages => {
            displayMessages(messages, userId);
        })
        .catch(error => console.error('Error fetching messages:', error));

    // Attach event listener for clearing chat
    document.addEventListener('DOMContentLoaded', function() {
        const clearChatLink = document.getElementById('clearChatLink');
        if (clearChatLink) {
            clearChatLink.addEventListener('click', function(event) {
                event.preventDefault();
                
                fetch(`/api/messages/${userId}/${roomId}/?clear_chat=true`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'chat cleared') {
                        const chatContainer = document.getElementById('id_chat_item_container');
                        if (chatContainer) {
                            chatContainer.innerHTML = '';
                        } else {
                            console.error('Element with id_chat_item_container not found');
                        }
                    }
                })
                .catch(error => console.error('Error clearing chat:', error));
            });
        } else {
            console.error('Clear chat link element not found');
        }
    });
}


function displayMessages(messages, userId) {
    const chatMessagesContainer = document.querySelector("#chatModalBody");
    chatMessagesContainer.innerHTML = '';  // Clear existing messages

    messages.forEach(message => {
        const messageElement = document.createElement("div");
        messageElement.classList.add("chat-message");

        const isMyMessage = message.sender_id === userId;

        messageElement.innerHTML = `
            <img src="${message.sender_profile_pic}" alt="Profile Picture" class="profile-pic" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
            <strong><span>${message.sender_first_name}</span> <span>${message.sender_last_name}</span> .</strong>
             <span class="timestamp" style="font-size: 0.8em; color: gray;">
                ${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
            </span>
            <div style="margin-left: 60px; margin-top: 5px; font-weight: none;"><span >${message.message}</span></div>
            
        `;
        
        chatMessagesContainer.appendChild(messageElement);
    });

    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
}

</script>